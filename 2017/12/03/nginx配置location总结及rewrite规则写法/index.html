<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16.png">
  <link rel="mask-icon" href="/images/logo-book.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" integrity="sha256-jTIdiMuX/e3DGJUGwl3pKSxuc6YOuqtJYkM0bGQESA4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"zhaoguibin.me","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.10.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="location正则写法一个示例： 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455location  &#x3D; &#x2F; &amp;#123;  # 精确匹配 &#x2F; ，主机名后面不能带任何字符串  [ configuration A ]&amp;#125;location">
<meta property="og:type" content="article">
<meta property="og:title" content="nginx配置location总结及rewrite规则写法">
<meta property="og:url" content="http://zhaoguibin.me/2017/12/03/nginx%E9%85%8D%E7%BD%AElocation%E6%80%BB%E7%BB%93%E5%8F%8Arewrite%E8%A7%84%E5%88%99%E5%86%99%E6%B3%95/index.html">
<meta property="og:site_name" content="zhaoguibin">
<meta property="og:description" content="location正则写法一个示例： 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455location  &#x3D; &#x2F; &amp;#123;  # 精确匹配 &#x2F; ，主机名后面不能带任何字符串  [ configuration A ]&amp;#125;location">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2017-12-03T09:07:09.000Z">
<meta property="article:modified_time" content="2021-02-03T03:50:09.000Z">
<meta property="article:author" content="zhaoguibin">
<meta property="article:tag" content="nginx">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://zhaoguibin.me/2017/12/03/nginx%E9%85%8D%E7%BD%AElocation%E6%80%BB%E7%BB%93%E5%8F%8Arewrite%E8%A7%84%E5%88%99%E5%86%99%E6%B3%95/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://zhaoguibin.me/2017/12/03/nginx%E9%85%8D%E7%BD%AElocation%E6%80%BB%E7%BB%93%E5%8F%8Arewrite%E8%A7%84%E5%88%99%E5%86%99%E6%B3%95/","path":"2017/12/03/nginx配置location总结及rewrite规则写法/","title":"nginx配置location总结及rewrite规则写法"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>nginx配置location总结及rewrite规则写法 | zhaoguibin</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">zhaoguibin</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">笔记</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="zhaoguibin"
      src="/images/astronaut.jpg">
  <p class="site-author-name" itemprop="name">zhaoguibin</p>
  <div class="site-description" itemprop="description">个人平时问题记录</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">121</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/zhaoguibin" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zhaoguibin" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhaoguibinx@gmail.com" title="E-Mail → mailto:zhaoguibinx@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://zhaoguibin.me/2017/12/03/nginx%E9%85%8D%E7%BD%AElocation%E6%80%BB%E7%BB%93%E5%8F%8Arewrite%E8%A7%84%E5%88%99%E5%86%99%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/astronaut.jpg">
      <meta itemprop="name" content="zhaoguibin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhaoguibin">
      <meta itemprop="description" content="个人平时问题记录">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="nginx配置location总结及rewrite规则写法 | zhaoguibin">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          nginx配置location总结及rewrite规则写法
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-12-03 17:07:09" itemprop="dateCreated datePublished" datetime="2017-12-03T17:07:09+08:00">2017-12-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2021-02-03 11:50:09" itemprop="dateModified" datetime="2021-02-03T11:50:09+08:00">2021-02-03</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>location正则写法<br>一个示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">location  = / &#123;</span><br><span class="line">  <span class="comment"># 精确匹配 / ，主机名后面不能带任何字符串</span></span><br><span class="line">  [ configuration A ]</span><br><span class="line">&#125;</span><br><span class="line">location  / &#123;</span><br><span class="line">  <span class="comment"># 因为所有的地址都以 / 开头，所以这条规则将匹配到所有请求</span></span><br><span class="line">  <span class="comment"># 但是正则和最长字符串会优先匹配</span></span><br><span class="line">  [ configuration B ]</span><br><span class="line">&#125;</span><br><span class="line">location /documents/ &#123;</span><br><span class="line">  <span class="comment"># 匹配任何以 /documents/ 开头的地址，匹配符合以后，还要继续往下搜索</span></span><br><span class="line">  <span class="comment"># 只有后面的正则表达式没有匹配到时，这一条才会采用这一条</span></span><br><span class="line">  [ configuration C ]</span><br><span class="line">&#125;</span><br><span class="line">location ~ /documents/Abc &#123;</span><br><span class="line">  <span class="comment"># 匹配任何以 /documents/ 开头的地址，匹配符合以后，还要继续往下搜索</span></span><br><span class="line">  <span class="comment"># 只有后面的正则表达式没有匹配到时，这一条才会采用这一条</span></span><br><span class="line">  [ configuration CC ]</span><br><span class="line">&#125;</span><br><span class="line">location ^~ /images/ &#123;</span><br><span class="line">  <span class="comment"># 匹配任何以 /images/ 开头的地址，匹配符合以后，停止往下搜索正则，采用这一条。</span></span><br><span class="line">  [ configuration D ]</span><br><span class="line">&#125;</span><br><span class="line">location ~* \.(gif|jpg|jpeg)$ &#123;</span><br><span class="line">  <span class="comment"># 匹配所有以 gif,jpg或jpeg 结尾的请求</span></span><br><span class="line">  <span class="comment"># 然而，所有请求 /images/ 下的图片会被 config D 处理，因为 ^~ 到达不了这一条正则</span></span><br><span class="line">  [ configuration E ]</span><br><span class="line">&#125;</span><br><span class="line">location /images/ &#123;</span><br><span class="line">  <span class="comment"># 字符匹配到 /images/，继续往下，会发现 ^~ 存在</span></span><br><span class="line">  [ configuration F ]</span><br><span class="line">&#125;</span><br><span class="line">location /images/abc &#123;</span><br><span class="line">  <span class="comment"># 最长字符匹配到 /images/abc，继续往下，会发现 ^~ 存在</span></span><br><span class="line">  <span class="comment"># F与G的放置顺序是没有关系的</span></span><br><span class="line">  [ configuration G ]</span><br><span class="line">&#125;</span><br><span class="line">location ~ /images/abc/ &#123;</span><br><span class="line">  <span class="comment"># 只有去掉 config D 才有效：先最长匹配 config G 开头的地址，继续往下搜索，匹配到这一条正则，采用</span></span><br><span class="line">    [ configuration H ]</span><br><span class="line">&#125;</span><br><span class="line">1</span><br><span class="line">location ~* /js/.*/\.js</span><br><span class="line">已=开头表示精确匹配</span><br><span class="line"></span><br><span class="line">如 A 中只匹配根目录结尾的请求，后面不能带任何字符串。</span><br><span class="line"></span><br><span class="line">^~ 开头表示uri以某个常规字符串开头，不是正则匹配</span><br><span class="line"></span><br><span class="line">~ 开头表示区分大小写的正则匹配;</span><br><span class="line"></span><br><span class="line">~* 开头表示不区分大小写的正则匹配</span><br><span class="line"></span><br><span class="line">/ 通用匹配, 如果没有其它匹配,任何请求都会匹配到</span><br><span class="line">顺序 no优先级： (location =) &gt; (location 完整路径) &gt; (location ^~ 路径) &gt; (location ~,~* 正则顺序) &gt; (location 部分起始路径) &gt; (/)</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<p>上面的匹配结果 按照上面的location写法，以下的匹配示例成立：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br></pre></td><td class="code"><pre><span class="line">/ -&gt; config A</span><br><span class="line">精确完全匹配，即使/index.html也匹配不了</span><br><span class="line">/downloads/download.html -&gt; config B</span><br><span class="line">匹配B以后，往下没有任何匹配，采用B</span><br><span class="line">/images/1.gif -&gt; configuration D</span><br><span class="line">匹配到F，往下匹配到D，停止往下</span><br><span class="line">/images/abc/def -&gt; config D</span><br><span class="line">最长匹配到G，往下匹配D，停止往下</span><br><span class="line">你可以看到 任何以/images/开头的都会匹配到D并停止，FG写在这里是没有任何意义的，H是永远轮不到的，这里只是为了说明匹配顺序</span><br><span class="line">/documents/document.html -&gt; config C</span><br><span class="line">匹配到C，往下没有任何匹配，采用C</span><br><span class="line">/documents/1.jpg -&gt; configuration E</span><br><span class="line">匹配到C，往下正则匹配到E</span><br><span class="line">/documents/Abc.jpg -&gt; config CC</span><br><span class="line">最长匹配到C，往下正则顺序匹配到CC，不会往下到E</span><br><span class="line">实际使用建议</span><br><span class="line">所以实际使用中，个人觉得至少有三个匹配规则定义，如下：</span><br><span class="line">#直接匹配网站根，通过域名访问网站首页比较频繁，使用这个会加速处理，官网如是说。</span><br><span class="line">#这里是直接转发给后端应用服务器了，也可以是一个静态首页</span><br><span class="line"># 第一个必选规则</span><br><span class="line">location = / &#123;</span><br><span class="line">    proxy_pass http://tomcat:8080/index</span><br><span class="line">&#125;</span><br><span class="line"># 第二个必选规则是处理静态文件请求，这是nginx作为http服务器的强项</span><br><span class="line"># 有两种配置模式，目录匹配或后缀匹配,任选其一或搭配使用</span><br><span class="line">location ^~ /static/ &#123;</span><br><span class="line">    root /webroot/static/;</span><br><span class="line">&#125;</span><br><span class="line">location ~* \.(gif|jpg|jpeg|png|css|js|ico)$ &#123;</span><br><span class="line">    root /webroot/res/;</span><br><span class="line">&#125;</span><br><span class="line">#第三个规则就是通用规则，用来转发动态请求到后端应用服务器</span><br><span class="line">#非静态文件请求就默认是动态请求，自己根据实际把握</span><br><span class="line">#毕竟目前的一些框架的流行，带.php,.jsp后缀的情况很少了</span><br><span class="line">location / &#123;</span><br><span class="line">    proxy_pass http://tomcat:8080/</span><br><span class="line">&#125;</span><br><span class="line">http://tengine.taobao.org/book/chapter_02.html</span><br><span class="line">http://nginx.org/en/docs/http/ngx_http_rewrite_module.html</span><br><span class="line">Rewrite规则</span><br><span class="line"></span><br><span class="line">rewrite功能就是，使用nginx提供的全局变量或自己设置的变量，结合正则表达式和标志位实现url重写以及重定向。rewrite只能放在server&#123;&#125;,location&#123;&#125;,if&#123;&#125;中，并且只能对域名后边的除去传递的参数外的字符串起作用，例如 http://seanlook.com/a/we/index.php?id=1&amp;u=str 只对/a/we/index.php重写。语法rewrite regex replacement [flag];</span><br><span class="line"></span><br><span class="line">如果相对域名或参数字符串起作用，可以使用全局变量匹配，也可以使用proxy_pass反向代理。</span><br><span class="line"></span><br><span class="line">表明看rewrite和location功能有点像，都能实现跳转，主要区别在于rewrite是在同一域名内更改获取资源的路径，而location是对一类路径做控制访问或反向代理，可以proxy_pass到其他机器。很多情况下rewrite也会写在location里，它们的执行顺序是：</span><br><span class="line"></span><br><span class="line">执行server块的rewrite指令</span><br><span class="line">执行location匹配</span><br><span class="line">执行选定的location中的rewrite指令</span><br><span class="line">如果其中某步URI被重写，则重新循环执行1-3，直到找到真实存在的文件；循环超过10次，则返回500 Internal Server Error错误。</span><br><span class="line">flag标志位</span><br><span class="line">last : 相当于Apache的[L]标记，表示完成rewrite</span><br><span class="line">break : 停止执行当前虚拟主机的后续rewrite指令集</span><br><span class="line">redirect : 返回302临时重定向，地址栏会显示跳转后的地址</span><br><span class="line">permanent : 返回301永久重定向，地址栏会显示跳转后的地址</span><br><span class="line">因为301和302不能简单的只返回状态码，还必须有重定向的URL，这就是return指令无法返回301,302的原因了。这里 last 和 break 区别有点难以理解：</span><br><span class="line">last一般写在server和if中，而break一般使用在location中</span><br><span class="line">last不终止重写后的url匹配，即新的url会再从server走一遍匹配流程，而break终止重写后的匹配</span><br><span class="line">break和last都能组织继续执行后面的rewrite指令</span><br><span class="line">if指令与全局变量</span><br><span class="line">if判断指令</span><br><span class="line">语法为if(condition)&#123;...&#125;，对给定的条件condition进行判断。如果为真，大括号内的rewrite指令将被执行，if条件(conditon)可以是如下任何内容：</span><br><span class="line">当表达式只是一个变量时，如果值为空或任何以0开头的字符串都会当做false</span><br><span class="line">直接比较变量和内容时，使用=或!=</span><br><span class="line">~正则表达式匹配，~*不区分大小写的匹配，!~区分大小写的不匹配</span><br><span class="line">-f和!-f用来判断是否存在文件</span><br><span class="line">-d和!-d用来判断是否存在目录</span><br><span class="line">-e和!-e用来判断是否存在文件或目录</span><br><span class="line">-x和!-x用来判断文件是否可执行</span><br><span class="line">例如：</span><br><span class="line">if ($http_user_agent ~ MSIE) &#123;</span><br><span class="line">    rewrite ^(.*)$ /msie/$1 break;</span><br><span class="line">&#125; //如果UA包含&quot;MSIE&quot;，rewrite请求到/msid/目录下</span><br><span class="line">if ($http_cookie ~* &quot;id=([^;]+)(?:;|$)&quot;) &#123;</span><br><span class="line">    set $id $1;</span><br><span class="line"> &#125; //如果cookie匹配正则，设置变量$id等于正则引用部分</span><br><span class="line">if ($request_method = POST) &#123;</span><br><span class="line">    return 405;</span><br><span class="line">&#125; //如果提交方法为POST，则返回状态405（Method not allowed）。return不能返回301,302</span><br><span class="line">if ($slow) &#123;</span><br><span class="line">    limit_rate 10k;</span><br><span class="line">&#125; //限速，$slow可以通过 set 指令设置</span><br><span class="line">if (!-f $request_filename)&#123;</span><br><span class="line">    break;</span><br><span class="line">    proxy_pass  http://127.0.0.1;</span><br><span class="line">&#125; //如果请求的文件名不存在，则反向代理到localhost 。这里的break也是停止rewrite检查</span><br><span class="line">if ($args ~ post=140)&#123;</span><br><span class="line">    rewrite ^ http://example.com/ permanent;</span><br><span class="line">&#125; //如果query string中包含&quot;post=140&quot;，永久重定向到example.com</span><br><span class="line">location ~* \.(gif|jpg|png|swf|flv)$ &#123;</span><br><span class="line">    valid_referers none blocked www.jefflei.com www.leizhenfang.com;</span><br><span class="line">    if ($invalid_referer) &#123;</span><br><span class="line">        return 404;</span><br><span class="line">    &#125; //防盗链</span><br><span class="line">&#125;</span><br><span class="line">全局变量</span><br><span class="line">下面是可以用作if判断的全局变量</span><br><span class="line">$args ： #这个变量等于请求行中的参数，同$query_string</span><br><span class="line">$content_length ： 请求头中的Content-length字段。</span><br><span class="line">$content_type ： 请求头中的Content-Type字段。</span><br><span class="line">$document_root ： 当前请求在root指令中指定的值。</span><br><span class="line">$host ： 请求主机头字段，否则为服务器名称。</span><br><span class="line">$http_user_agent ： 客户端agent信息</span><br><span class="line">$http_cookie ： 客户端cookie信息</span><br><span class="line">$limit_rate ： 这个变量可以限制连接速率。</span><br><span class="line">$request_method ： 客户端请求的动作，通常为GET或POST。</span><br><span class="line">$remote_addr ： 客户端的IP地址。</span><br><span class="line">$remote_port ： 客户端的端口。</span><br><span class="line">$remote_user ： 已经经过Auth Basic Module验证的用户名。</span><br><span class="line">$request_filename ： 当前请求的文件路径，由root或alias指令与URI请求生成。</span><br><span class="line">$scheme ： HTTP方法（如http，https）。</span><br><span class="line">$server_protocol ： 请求使用的协议，通常是HTTP/1.0或HTTP/1.1。</span><br><span class="line">$server_addr ： 服务器地址，在完成一次系统调用后可以确定这个值。</span><br><span class="line">$server_name ： 服务器名称。</span><br><span class="line">$server_port ： 请求到达服务器的端口号。</span><br><span class="line">$request_uri ： 包含请求参数的原始URI，不包含主机名，如：”/foo/bar.php?arg=baz”。</span><br><span class="line">$uri ： 不带请求参数的当前URI，$uri不包含主机名，如”/foo/bar.html”。</span><br><span class="line">$document_uri ： 与$uri相同。</span><br><span class="line">例：http://localhost:88/test1/test2/test.php</span><br><span class="line">$host：localhost</span><br><span class="line">$server_port：88</span><br><span class="line">$request_uri：http://localhost:88/test1/test2/test.php</span><br><span class="line">$document_uri：/test1/test2/test.php</span><br><span class="line">$document_root：/var/www/html</span><br><span class="line">$request_filename：/var/www/html/test1/test2/test.php</span><br><span class="line">常用正则</span><br><span class="line">. ： 匹配除换行符以外的任意字符</span><br><span class="line">? ： 重复0次或1次</span><br><span class="line">+ ： 重复1次或更多次</span><br><span class="line">* ： 重复0次或更多次</span><br><span class="line">\d ：匹配数字</span><br><span class="line">^ ： 匹配字符串的开始</span><br><span class="line">$ ： 匹配字符串的介绍</span><br><span class="line">&#123;n&#125; ： 重复n次</span><br><span class="line">&#123;n,&#125; ： 重复n次或更多次</span><br><span class="line">[c] ： 匹配单个字符c</span><br><span class="line">[a-z] ： 匹配a-z小写字母的任意一个</span><br><span class="line">小括号()之间匹配的内容，可以在后面通过$1来引用，$2表示的是前面第二个()里的内容。正则里面容易让人困惑的是\转义特殊字符。</span><br><span class="line">rewrite实例</span><br><span class="line">例1：</span><br><span class="line">http &#123;</span><br><span class="line">    # 定义image日志格式</span><br><span class="line">    log_format imagelog &#x27;[$time_local] &#x27; $image_file &#x27; &#x27; $image_type &#x27; &#x27; $body_bytes_sent &#x27; &#x27; $status;</span><br><span class="line">    # 开启重写日志</span><br><span class="line">    rewrite_log on;</span><br><span class="line">    server &#123;</span><br><span class="line">        root /home/www;</span><br><span class="line">        location / &#123;</span><br><span class="line">                # 重写规则信息</span><br><span class="line">                error_log logs/rewrite.log notice;</span><br><span class="line">                # 注意这里要用‘’单引号引起来，避免&#123;&#125;</span><br><span class="line">                rewrite &#x27;^/images/([a-z]&#123;2&#125;)/([a-z0-9]&#123;5&#125;)/(.*)\.(png|jpg|gif)$&#x27; /data?file=$3.$4;</span><br><span class="line">                # 注意不能在上面这条规则后面加上“last”参数，否则下面的set指令不会执行</span><br><span class="line">                set $image_file $3;</span><br><span class="line">                set $image_type $4;</span><br><span class="line">        &#125;</span><br><span class="line">        location /data &#123;</span><br><span class="line">                # 指定针对图片的日志格式，来分析图片类型和大小</span><br><span class="line">                access_log logs/images.log mian;</span><br><span class="line">                root /data/images;</span><br><span class="line">                # 应用前面定义的变量。判断首先文件在不在，不在再判断目录在不在，如果还不在就跳转到最后一个url里</span><br><span class="line">                try_files /$arg_file /image404.html;</span><br><span class="line">        &#125;</span><br><span class="line">        location = /image404.html &#123;</span><br><span class="line">                # 图片不存在返回特定的信息</span><br><span class="line">                return 404 &quot;image not found\n&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">对形如/images/ef/uh7b3/test.png的请求，重写到/data?file=test.png，于是匹配到location /data，先看/data/images/test.png文件存不存在，如果存在则正常响应，如果不存在则重写tryfiles到新的image404 location，直接返回404状态码。</span><br><span class="line">例2：</span><br><span class="line">rewrite ^/images/(.*)_(\d+)x(\d+)\.(png|jpg|gif)$ /resizer/$1.$4?width=$2&amp;height=$3? last;</span><br><span class="line">对形如/images/bla_500x400.jpg的文件请求，重写到/resizer/bla.jpg?width=500&amp;height=400地址，并会继续尝试匹配location。</span><br><span class="line">一．正则表达式匹配，其中：</span><br><span class="line">* ~ 为区分大小写匹配</span><br><span class="line">* ~* 为不区分大小写匹配</span><br><span class="line">* !~和!~*分别为区分大小写不匹配及不区分大小写不匹配</span><br><span class="line">二．文件及目录匹配，其中：</span><br><span class="line">* -f和!-f用来判断是否存在文件</span><br><span class="line">* -d和!-d用来判断是否存在目录</span><br><span class="line">* -e和!-e用来判断是否存在文件或目录</span><br><span class="line">* -x和!-x用来判断文件是否可执行</span><br><span class="line">三．rewrite指令的最后一项参数为flag标记，flag标记有：</span><br><span class="line">1.last    相当于apache里面的[L]标记，表示rewrite。</span><br><span class="line">2.break本条规则匹配完成后，终止匹配，不再匹配后面的规则。</span><br><span class="line">3.redirect  返回302临时重定向，浏览器地址会显示跳转后的URL地址。</span><br><span class="line">4.permanent  返回301永久重定向，浏览器地址会显示跳转后的URL地址。</span><br><span class="line">使用last和break实现URI重写，浏览器地址栏不变。而且两者有细微差别，使用alias指令必须用last标记;使用proxy_pass指令时，需要使用break标记。Last标记在本条rewrite规则执行完毕后，会对其所在server&#123;......&#125;标签重新发起请求，而break标记则在本条规则匹配完成后，终止匹配。</span><br><span class="line">例如：如果我们将类似URL/photo/123456 重定向到/path/to/photo/12/1234/123456.png</span><br><span class="line">rewrite &quot;/photo/([0-9]&#123;2&#125;)([0-9]&#123;2&#125;)([0-9]&#123;2&#125;)&quot;/path/to/photo/$1/$1$2/$1$2$3.png ;</span><br><span class="line">四．NginxRewrite 规则相关指令</span><br><span class="line">1.break指令</span><br><span class="line">使用环境：server,location,if;</span><br><span class="line">该指令的作用是完成当前的规则集，不再处理rewrite指令。</span><br><span class="line">2.if指令</span><br><span class="line">使用环境：server,location</span><br><span class="line">该指令用于检查一个条件是否符合，如果条件符合，则执行大括号内的语句。If指令不支持嵌套，不支持多个条件&amp;&amp;和||处理。</span><br><span class="line">3.return指令</span><br><span class="line">语法：returncode ;</span><br><span class="line">使用环境：server,location,if;</span><br><span class="line">该指令用于结束规则的执行并返回状态码给客户端。</span><br><span class="line">示例：如果访问的URL以&quot;.sh&quot;或&quot;.bash&quot;结尾，则返回403状态码</span><br><span class="line">location ~ .*\.(sh|bash)?$</span><br><span class="line">&#123;</span><br><span class="line">return 403;</span><br><span class="line">&#125;</span><br><span class="line">4.rewrite 指令</span><br><span class="line">语法：rewriteregex replacement flag</span><br><span class="line">使用环境：server,location,if</span><br><span class="line">该指令根据表达式来重定向URI，或者修改字符串。指令根据配置文件中的顺序来执行。注意重写表达式只对相对路径有效。如果你想配对主机名，你应该使用if语句，示例如下：</span><br><span class="line">if( $host ~* www\.(.*) )</span><br><span class="line">&#123;</span><br><span class="line">set $host_without_www $1;</span><br><span class="line">rewrite ^(.*)$  http://$host_without_www$1permanent;</span><br><span class="line">&#125;</span><br><span class="line">5.Set指令</span><br><span class="line">语法：setvariable value ; 默认值:none; 使用环境：server,location,if;</span><br><span class="line">该指令用于定义一个变量，并给变量赋值。变量的值可以为文本、变量以及文本变量的联合。</span><br><span class="line">示例：set$varname &quot;hello world&quot;;</span><br><span class="line">6.Uninitialized_variable_warn指令</span><br><span class="line">语法：uninitialized_variable_warnon|off</span><br><span class="line">使用环境：http,server,location,if</span><br><span class="line">该指令用于开启和关闭未初始化变量的警告信息，默认值为开启。</span><br><span class="line">五．Nginx的Rewrite规则编写实例</span><br><span class="line">1.当访问的文件和目录不存在时，重定向到某个php文件</span><br><span class="line">if( !-e $request_filename )</span><br><span class="line">&#123;</span><br><span class="line">rewrite ^/(.*)$ index.php last;</span><br><span class="line">&#125;</span><br><span class="line">2.目录对换 /123456/xxxx  ====&gt;  /xxxx?id=123456</span><br><span class="line">rewrite ^/(\d+)/(.+)/  /$2?id=$1 last;</span><br><span class="line">3.如果客户端使用的是IE浏览器，则重定向到/ie目录下</span><br><span class="line">if( $http_user_agent  ~ MSIE)</span><br><span class="line">&#123;</span><br><span class="line">rewrite ^(.*)$ /ie/$1 break;</span><br><span class="line">&#125;</span><br><span class="line">4.禁止访问多个目录</span><br><span class="line">location ~ ^/(cron|templates)/</span><br><span class="line">&#123;</span><br><span class="line">deny all;</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br><span class="line">5.禁止访问以/data开头的文件</span><br><span class="line">location ~ ^/data</span><br><span class="line">&#123;</span><br><span class="line">deny all;</span><br><span class="line">&#125;</span><br><span class="line">6.禁止访问以.sh,.flv,.mp3为文件后缀名的文件</span><br><span class="line">location ~ .*\.(sh|flv|mp3)$</span><br><span class="line">&#123;</span><br><span class="line">return 403;</span><br><span class="line">&#125;</span><br><span class="line">7.设置某些类型文件的浏览器缓存时间</span><br><span class="line">location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$</span><br><span class="line">&#123;</span><br><span class="line">expires 30d;</span><br><span class="line">&#125;</span><br><span class="line">location ~ .*\.(js|css)$</span><br><span class="line">&#123;</span><br><span class="line">expires 1h;</span><br><span class="line">&#125;</span><br><span class="line">8.给favicon.ico和robots.txt设置过期时间;</span><br><span class="line">这里为favicon.ico为99天,robots.txt为7天并不记录404错误日志</span><br><span class="line">location ~(favicon.ico) &#123;</span><br><span class="line">log_not_found off;</span><br><span class="line">expires 99d;</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br><span class="line">location ~(robots.txt) &#123;</span><br><span class="line">log_not_found off;</span><br><span class="line">expires 7d;</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br><span class="line">9.设定某个文件的过期时间;这里为600秒，并不记录访问日志</span><br><span class="line">location ^~ /html/scripts/loadhead_1.js &#123;</span><br><span class="line">access_log  off;</span><br><span class="line">root /opt/lampp/htdocs/web;</span><br><span class="line">expires 600;</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br><span class="line">10.文件反盗链并设置过期时间</span><br><span class="line">这里的return412 为自定义的http状态码，默认为403，方便找出正确的盗链的请求</span><br><span class="line">“rewrite ^/ http://img.linuxidc.net/leech.gif;”显示一张防盗链图片</span><br><span class="line">“access_log off;”不记录访问日志，减轻压力</span><br><span class="line">“expires 3d”所有文件3天的浏览器缓存</span><br><span class="line">location ~*^.+\.(jpg|jpeg|gif|png|swf|rar|zip|css|js)$ &#123;</span><br><span class="line">valid_referers none blocked *.linuxidc.com*.linuxidc.net localhost 208.97.167.194;</span><br><span class="line">if ($invalid_referer) &#123;</span><br><span class="line">rewrite ^/ http://img.linuxidc.net/leech.gif;</span><br><span class="line">return 412;</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br><span class="line">access_log  off;</span><br><span class="line">root /opt/lampp/htdocs/web;</span><br><span class="line">expires 3d;</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br><span class="line">11.只允许固定ip访问网站，并加上密码</span><br><span class="line">root /opt/htdocs/www;</span><br><span class="line">allow  208.97.167.194;</span><br><span class="line">allow  222.33.1.2;</span><br><span class="line">allow  231.152.49.4;</span><br><span class="line">deny  all;</span><br><span class="line">auth_basic “C1G_ADMIN”;</span><br><span class="line">auth_basic_user_file htpasswd;</span><br><span class="line">12将多级目录下的文件转成一个文件，增强seo效果</span><br><span class="line">/job-123-456-789.html 指向/job/123/456/789.html</span><br><span class="line">rewrite^/job-([0-9]+)-([0-9]+)-([0-9]+)\.html$ /job/$1/$2/jobshow_$3.html last;</span><br><span class="line">13.文件和目录不存在的时候重定向：</span><br><span class="line">if (!-e $request_filename) &#123;</span><br><span class="line">proxy_pass http://127.0.0.1;</span><br><span class="line">&#125;</span><br><span class="line">14.将根目录下某个文件夹指向2级目录</span><br><span class="line">如/shanghaijob/ 指向 /area/shanghai/</span><br><span class="line">如果你将last改成permanent，那么浏览器地址栏显是/location/shanghai/</span><br><span class="line">rewrite ^/([0-9a-z]+)job/(.*)$ /area/$1/$2last;</span><br><span class="line">上面例子有个问题是访问/shanghai时将不会匹配</span><br><span class="line">rewrite ^/([0-9a-z]+)job$ /area/$1/ last;</span><br><span class="line">rewrite ^/([0-9a-z]+)job/(.*)$ /area/$1/$2last;</span><br><span class="line">这样/shanghai 也可以访问了，但页面中的相对链接无法使用，</span><br><span class="line">如./list_1.html真实地址是/area/shanghia/list_1.html会变成/list_1.html,导至无法访问。</span><br><span class="line">那我加上自动跳转也是不行咯</span><br><span class="line">(-d $request_filename)它有个条件是必需为真实目录，而我的rewrite不是的，所以没有效果</span><br><span class="line">if (-d $request_filename)&#123;</span><br><span class="line">rewrite ^/(.*)([^/])$ http://$host/$1$2/permanent;</span><br><span class="line">&#125;</span><br><span class="line">知道原因后就好办了，让我手动跳转吧</span><br><span class="line">rewrite ^/([0-9a-z]+)job$ /$1job/permanent;</span><br><span class="line">rewrite ^/([0-9a-z]+)job/(.*)$ /area/$1/$2last;</span><br><span class="line">15.域名跳转</span><br><span class="line">server</span><br><span class="line">&#123;</span><br><span class="line">listen      80;</span><br><span class="line">server_name  jump.linuxidc.com;</span><br><span class="line">index index.html index.htm index.php;</span><br><span class="line">root  /opt/lampp/htdocs/www;</span><br><span class="line">rewrite ^/ http://www.linuxidc.com/;</span><br><span class="line">access_log  off;</span><br><span class="line">&#125;</span><br><span class="line">16.多域名转向</span><br><span class="line">server_name  www.linuxidc.comwww.linuxidc.net;</span><br><span class="line">index index.html index.htm index.php;</span><br><span class="line">root  /opt/lampp/htdocs;</span><br><span class="line">if ($host ~ &quot;linuxidc\.net&quot;) &#123;</span><br><span class="line">rewrite ^(.*) http://www.linuxidc.com$1permanent;</span><br><span class="line">&#125;</span><br><span class="line">六．nginx全局变量</span><br><span class="line">arg_PARAMETER    #这个变量包含GET请求中，如果有变量PARAMETER时的值。</span><br><span class="line">args                    #这个变量等于请求行中(GET请求)的参数，如：foo=123&amp;bar=blahblah;</span><br><span class="line">binary_remote_addr #二进制的客户地址。</span><br><span class="line">body_bytes_sent    #响应时送出的body字节数数量。即使连接中断，这个数据也是精确的。</span><br><span class="line">content_length    #请求头中的Content-length字段。</span><br><span class="line">content_type      #请求头中的Content-Type字段。</span><br><span class="line">cookie_COOKIE    #cookie COOKIE变量的值</span><br><span class="line">document_root    #当前请求在root指令中指定的值。</span><br><span class="line">document_uri      #与uri相同。</span><br><span class="line">host                #请求主机头字段，否则为服务器名称。</span><br><span class="line">hostname          #Set to themachine’s hostname as returned by gethostname</span><br><span class="line">http_HEADER</span><br><span class="line">is_args              #如果有args参数，这个变量等于”?”，否则等于”&quot;，空值。</span><br><span class="line">http_user_agent    #客户端agent信息</span><br><span class="line">http_cookie          #客户端cookie信息</span><br><span class="line">limit_rate            #这个变量可以限制连接速率。</span><br><span class="line">query_string          #与args相同。</span><br><span class="line">request_body_file  #客户端请求主体信息的临时文件名。</span><br><span class="line">request_method    #客户端请求的动作，通常为GET或POST。</span><br><span class="line">remote_addr          #客户端的IP地址。</span><br><span class="line">remote_port          #客户端的端口。</span><br><span class="line">remote_user          #已经经过Auth Basic Module验证的用户名。</span><br><span class="line">request_completion #如果请求结束，设置为OK. 当请求未结束或如果该请求不是请求链串的最后一个时，为空(Empty)。</span><br><span class="line">request_method    #GET或POST</span><br><span class="line">request_filename  #当前请求的文件路径，由root或alias指令与URI请求生成。</span><br><span class="line">request_uri          #包含请求参数的原始URI，不包含主机名，如：”/foo/bar.php?arg=baz”。不能修改。</span><br><span class="line">scheme                #HTTP方法（如http，https）。</span><br><span class="line">server_protocol      #请求使用的协议，通常是HTTP/1.0或HTTP/1.1。</span><br><span class="line">server_addr          #服务器地址，在完成一次系统调用后可以确定这个值。</span><br><span class="line">server_name        #服务器名称。</span><br><span class="line">server_port          #请求到达服务器的端口号。</span><br><span class="line">七．Apache和Nginx规则的对应关系</span><br><span class="line">Apache的RewriteCond对应Nginx的if</span><br><span class="line">Apache的RewriteRule对应Nginx的rewrite</span><br><span class="line">Apache的[R]对应Nginx的redirect</span><br><span class="line">Apache的[P]对应Nginx的last</span><br><span class="line">Apache的[R,L]对应Nginx的redirect</span><br><span class="line">Apache的[P,L]对应Nginx的last</span><br><span class="line">Apache的[PT,L]对应Nginx的last</span><br><span class="line">例如：允许指定的域名访问本站，其他的域名一律转向www.linuxidc.net</span><br><span class="line">  Apache:</span><br><span class="line">RewriteCond %&#123;HTTP_HOST&#125; !^(.*?)\.aaa\.com$[NC]</span><br><span class="line">RewriteCond %&#123;HTTP_HOST&#125; !^localhost$</span><br><span class="line">RewriteCond %&#123;HTTP_HOST&#125;!^192\.168\.0\.(.*?)$</span><br><span class="line">RewriteRule ^/(.*)$ http://www.linuxidc.net[R,L]</span><br><span class="line">  Nginx:</span><br><span class="line">if( $host ~* ^(.*)\.aaa\.com$ )</span><br><span class="line">&#123;</span><br><span class="line">set $allowHost ‘1’;</span><br><span class="line">&#125;</span><br><span class="line">if( $host ~* ^localhost )</span><br><span class="line">&#123;</span><br><span class="line">set $allowHost ‘1’;</span><br><span class="line">&#125;</span><br><span class="line">if( $host ~* ^192\.168\.1\.(.*?)$ )</span><br><span class="line">&#123;</span><br><span class="line">set $allowHost ‘1’;</span><br><span class="line">&#125;</span><br><span class="line">if( $allowHost !~ ‘1’ )</span><br><span class="line">&#123;</span><br><span class="line">rewrite ^/(.*)$ http://www.linuxidc.netredirect ;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/nginx/" rel="tag"># nginx</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2017/12/03/nginx-php-fpm%E5%87%BA%E7%8E%B0502-bad-gateway%E9%94%99%E8%AF%AF%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/" rel="prev" title="nginx-php-fpm出现502-bad-gateway错误解决方法">
                  <i class="fa fa-chevron-left"></i> nginx-php-fpm出现502-bad-gateway错误解决方法
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2017/12/03/NGINX-%E5%90%AF%E5%8A%A8-warn-conflicting-server-name-%E2%80%9Cxxx-com%E2%80%9D-on-0-0-0-0-80-ignored%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90/" rel="next" title="NGINX-启动-warn-conflicting-server-name-“xxx-com”-on-0-0-0-0-80-ignored原因分析">
                  NGINX-启动-warn-conflicting-server-name-“xxx-com”-on-0-0-0-0-80-ignored原因分析 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhaoguibin</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  





</body>
</html>
